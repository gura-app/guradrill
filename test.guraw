#!/usr/bin/env gura
# encoding: utf-8
import(wx)
import(cairo)
import(Renderer)

GenUniqRand2(range1:number, range2:number, n:number) {block} = {
	tbl = []
	i = 0
	while (i < n):xiter {
		x1 = rand(range1), x2 = rand(range2)
		str = format('%d,%d', x1, x2)
		tbl.find(str) && continue
		tbl.add(str)
		!(rtn = block(x1, x2, i)) && continue
		i += 1
		rtn
	}
}

GenQuestion_001(n:number) = GenUniqRand2(range1 => 90, range2 => 90, n => n) {|a, b|
	if (a <= b) { continue }
	a += 10, b += 10
	r'${a} - ${b} = {}[border,width=5em,height=2em]'.embed()
}

GenQuestion_002(n:number) = GenUniqRand2(range1 => 90, range2 => 90, n => n) {|a, b|
	a += 10, b += 10
	r'${a} + ${b} = {}[border,width=5em,height=2em]'.embed()
}

tmplPage = R'''
{
	{
		{}[width=30mm,height=20mm,border]
		{hello}[width=130mm,height=20mm,border]
	}[pack,width=170mm,height=20mm,border]
	{
		${format(fmtQuestion, 1.., GenQuestion_001(24))}
	}[pack,width=170mm,height=230mm]
}[pack=vert,width=170mm,height=250mm,margin-top=27mm,margin-left=20mm]
'''.template()

App = class(wx.App) {
	OnInit() = {
		frame = FrameMain('Simple', wx.DefaultPosition, wx.Size(1000, 750))
		frame.Show()
		true
	}
}

PanelMain = class(wx.Panel) {
	__init__(parent:wx.Window) = {|parent, style => wx.BORDER_SUNKEN|
		randseed(os.clock())
		this.Bind(wx.EVT_PAINT) {|event| this.OnPaint(event) }
		this.canvas = Renderer.Canvas.CreateForPreview(Renderer.PaperSize@A4, .6)
		fmtQuestion = r'{\small (%d)}[width=8mm,align=center]{}[width=3mm]' + \
					r'{\large %s}[width=74mm,height=20mm]\n'
		this.canvas.Render(tmplPage.render())
		//Renderer.Compose(this.canvas)
		this.bmp = wx.Bitmap(this.canvas.GetImage())
	}
	OnPaint(event:wx.PaintEvent) = {
		dc = wx.PaintDC(this)
		this.bmp && dc.DrawBitmap(this.bmp, 0, 0, false)
		dc = nil
	}
}

FrameMain = class(wx.Frame) {
	__init__(title:string, pos:wx.Point, size:wx.Size) = {|nil, wx.ID_ANY, title, pos, size|
		menuBar = wx.MenuBar()
		this.SetMenuBar(menuBar)
		PanelMain(this)
	}
}

wx.IMPLEMENT_APP(App)
